!function(a,b){"use strict";var c={run:function(){this.$window=a(b),this.$header=a(".l-header"),this.$intro=a(".l-intro"),this.$fireworks=a(".l-fireworks"),this.$help=a(".help"),this.$helpButton=a(".help__button"),this.$helpList=a(".help__list"),this.windowHeight=b.innerHeight,this.headerHeight=this.$header.height(),this.useEaseScrollable(),this.resizeContentsHeight(),setTimeout(a.proxy(this.hideHelp,this),3e3),this.eventify()},eventify:function(){var b=this;b.$window.on("resize",a.proxy(b.resizeContentsHeight,b)),b.$helpButton.on("click",a.proxy(b.toggleHelp,b))},resizeContentsHeight:function(){var a;this.windowHeight=b.innerHeight,a=this.windowHeight-this.headerHeight,this.$intro.css("min-height",a),this.$fireworks.css("min-height",a)},useEaseScrollable:function(){a("a[href^=#]").easescrollable({easing:"easeInOutExpo",changehash:!1,adjustEndY:-this.headerHeight,dontAdjustEndYIfSelectorIs:"#all"})},toggleHelp:function(){this.$helpList.fadeToggle()},hideHelp:function(){this.$helpList.fadeOut()}};b.app=c,a(function(){c.run()})}(jQuery,this,this.document),function(){"use strict";function a(a){this.dispatchEvent({type:"mousedown"}),this._pointerStart.x=a.clientX,this._pointerStart.y=a.clientY,this._pointerLast.x=this.lon,this._pointerLast.y=this.lat,this.el.removeEventListener("mousemove",this._mousedragListener,!1),this.el.addEventListener("mousemove",this._mousedragListener,!1)}function b(){this.dispatchEvent({type:"mouseup"}),this.el.removeEventListener("mousemove",this._mousedragListener,!1)}function c(a){var b=this.el.offsetWidth,c=this.el.offsetHeight,d=(this._pointerStart.x-a.clientX)/b*2,e=(this._pointerStart.y-a.clientY)/c*2;this.lon=this._pointerLast.x+d*this.mouseAccelerationX,this.lat=this._pointerLast.y+e*this.mouseAccelerationY}window.NF14=window.NF14||{},NF14.view3d={},NF14.view3d.Viewport=function(a){THREE.EventDispatcher.prototype.apply(this),this.el=a,this.width=this.el.offsetWidth,this.height=this.el.offsetHeight,this.clock=new THREE.Clock,this.scene=new THREE.Scene,this.camera=new THREE.PerspectiveCamera(40,this.width/this.height,1,500),this.scene.add(this.camera),this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),this.renderer.setSize(this.width,this.height),this.renderer.setClearColor(0,0),this.el.appendChild(this.renderer.domElement)},NF14.view3d.Viewport.prototype.update=function(){this.dispatchEvent({type:"update"}),this.renderer.render(this.scene,this.camera)},NF14.view3d.Viewport.prototype.run=function(){this.isRunning=!0,this.loop()},NF14.view3d.Viewport.prototype.loop=function(){this.isRunning&&(requestAnimationFrame(this.loop.bind(this)),this.update())},NF14.view3d.Viewport.prototype.setSize=function(a,b){this.width=a,this.height=b,this.camera.aspect=this.width/this.height,this.camera.updateProjectionMatrix(),this.el.style.width=this.width+"px",this.el.style.height=this.height+"px",this.renderer.setSize(this.width,this.height)},NF14.view3d.CameraControl=function(d){THREE.EventDispatcher.prototype.apply(this),this.center=new THREE.Vector3(10,15,20),this.camera=d.camera,this.el=d.el,this.radius=20,this.lat=18,this.lon=14,this._phi,this._theta,this.mouseAccelerationX=100,this.mouseAccelerationY=30,this._pointerStart={x:0,y:0},this._pointerLast={x:0,y:0},this.camera.position.set(this.center.x,this.center.y,this.center.z+1),this.update(),this._mousedownListener=a.bind(this),this._mouseupListener=b.bind(this),this._mousedragListener=c.bind(this),this.el.addEventListener("mousedown",this._mousedownListener,!1),this.el.addEventListener("mouseup",this._mouseupListener,!1),this.el.addEventListener("mouseleave",this._mouseupListener,!1),d.addEventListener("update",this.update.bind(this))},NF14.view3d.CameraControl.prototype.update=function(){this.lat=this.lat>40?40:this.lat<-40?-40:this.lat,this.lon=this.lon>60?60:this.lon<-60?-60:this.lon,this._phi=THREE.Math.degToRad(this.lat),this._theta=-THREE.Math.degToRad(this.lon-90);var a=new THREE.Vector3(Math.cos(this._phi)*Math.cos(this._theta),Math.sin(this._phi),Math.cos(this._phi)*Math.sin(this._theta)).multiplyScalar(this.radius).add(this.center);this.camera.position.copy(a),90===this.lat?this.camera.up.set(Math.cos(this._theta+THREE.Math.degToRad(180)),0,Math.sin(this._theta+THREE.Math.degToRad(180))):-90===this.lat?this.camera.up.set(Math.cos(this._theta),0,Math.sin(this._theta)):this.camera.up.set(0,1,0),this.camera.lookAt(this.center)},NF14.view3d.BuildingMesh=function(){THREE.Object3D.call(this);var a,b,c,d=new THREE.MeshBasicMaterial({color:1810048,wireframe:!0}),e=this,f=function(a,b,c,d){var e=new THREE.Geometry,f=new THREE.Matrix4,g=new THREE.Geometry,h=new THREE.Geometry,i=new THREE.Geometry,j=new THREE.Geometry,k=new THREE.Geometry,l=new THREE.Geometry;return g.vertices=[new THREE.Vector3(-.5,-.5,-.5),new THREE.Vector3(.5,-.5,-.5),new THREE.Vector3(.5,-.5,-.5),new THREE.Vector3(.5,-.5,.5),new THREE.Vector3(.5,-.5,.5),new THREE.Vector3(-.5,-.5,.5),new THREE.Vector3(-.5,-.5,.5),new THREE.Vector3(-.5,-.5,-.5)],h.vertices=[new THREE.Vector3(-.5,.5,-.5),new THREE.Vector3(.5,.5,-.5),new THREE.Vector3(.5,.5,-.5),new THREE.Vector3(.5,.5,.5),new THREE.Vector3(.5,.5,.5),new THREE.Vector3(-.5,.5,.5),new THREE.Vector3(-.5,.5,.5),new THREE.Vector3(-.5,.5,-.5)],i.vertices=[new THREE.Vector3(-.5,-.5,-.5),new THREE.Vector3(-.5,.5,-.5)],j.vertices=[new THREE.Vector3(.5,-.5,-.5),new THREE.Vector3(.5,.5,-.5)],k.vertices=[new THREE.Vector3(.5,-.5,.5),new THREE.Vector3(.5,.5,.5)],l.vertices=[new THREE.Vector3(-.5,-.5,.5),new THREE.Vector3(-.5,.5,.5)],e.merge(g),e.merge(h),e.merge(i),e.merge(j),e.merge(k),e.merge(l),f.set(a,0,0,d.x*a,0,b,0,d.y*b,0,0,c,d.z*c,0,0,0,1),e.applyMatrix(f),e},g=4,h=new THREE.Vector3(10,2.5,10),i=new THREE.Geometry,j=1,k=g*h.y+.5,l=[];for(l=[[k,new THREE.Vector3(3.5*h.x,h.y/5,0)],[k,new THREE.Vector3(3*h.x,h.y/5,0)],[k,new THREE.Vector3(2.5*h.x,h.y/5,0)],[k,new THREE.Vector3(2*h.x,h.y/5,0)],[k,new THREE.Vector3(1.5*h.x,h.y/5,0)],[k,new THREE.Vector3(1*h.x,h.y/5,0)],[k,new THREE.Vector3(-1*h.x,h.y/5,0)],[k,new THREE.Vector3(-1.5*h.x,h.y/5,0)],[k,new THREE.Vector3(-2*h.x,h.y/5,0)],[k,new THREE.Vector3(-2.5*h.x,h.y/5,0)],[k,new THREE.Vector3(-3*h.x,h.y/5,0)],[k,new THREE.Vector3(-3.5*h.x,h.y/5,0)],[k+4,new THREE.Vector3(.5*h.x,h.y/5,0)],[k+4,new THREE.Vector3(0*h.x,h.y/5,0)],[k+4,new THREE.Vector3(h.x*-.5,h.y/5,0)]],b=0,c=l.length;c>b;b++)i.merge(f(j,l[b][0],j,l[b][1]));i.merge(i.clone(),(new THREE.Matrix4).makeTranslation(0,0,-h.z)),i.merge(f(j,h.y,j,new THREE.Vector3(.5*h.x,h.y/5,.5*h.z))),i.merge(f(j,h.y,j,new THREE.Vector3(h.x*-.5,h.y/5,.5*h.z)));var m=f(j,.5,h.z+1,new THREE.Vector3(0,.5,-.45));for(b=1,c=g+1;c>b;b++)i.merge(m.clone(),(new THREE.Matrix4).makeTranslation(3.5*h.x,h.y*b,0)),i.merge(m.clone(),(new THREE.Matrix4).makeTranslation(3*h.x,h.y*b,0)),i.merge(m.clone(),(new THREE.Matrix4).makeTranslation(2.5*h.x,h.y*b,0)),i.merge(m.clone(),(new THREE.Matrix4).makeTranslation(2*h.x,h.y*b,0)),i.merge(m.clone(),(new THREE.Matrix4).makeTranslation(1.5*h.x,h.y*b,0)),i.merge(m.clone(),(new THREE.Matrix4).makeTranslation(1*h.x,h.y*b,0)),i.merge(m.clone(),(new THREE.Matrix4).makeTranslation(.5*h.x,h.y*b,0)),i.merge(m.clone(),(new THREE.Matrix4).makeTranslation(0*h.x,h.y*b,0)),i.merge(m.clone(),(new THREE.Matrix4).makeTranslation(h.x*-.5,h.y*b,0)),i.merge(m.clone(),(new THREE.Matrix4).makeTranslation(-1*h.x,h.y*b,0)),i.merge(m.clone(),(new THREE.Matrix4).makeTranslation(-1.5*h.x,h.y*b,0)),i.merge(m.clone(),(new THREE.Matrix4).makeTranslation(-2*h.x,h.y*b,0)),i.merge(m.clone(),(new THREE.Matrix4).makeTranslation(-2.5*h.x,h.y*b,0)),i.merge(m.clone(),(new THREE.Matrix4).makeTranslation(-3*h.x,h.y*b,0)),i.merge(m.clone(),(new THREE.Matrix4).makeTranslation(-3.5*h.x,h.y*b,0));var n=new THREE.Geometry,o=new THREE.Geometry,p=new THREE.Geometry,q=[new THREE.Vector3(.5*h.x+j/2,0,-h.z-j/2),new THREE.Vector3(3.5*h.x+j/2,0,-h.z-j/2),new THREE.Vector3(3.5*h.x+j/2,0,0+j/2),new THREE.Vector3(.5*h.x+j/2,0,0+j/2),new THREE.Vector3(.5*h.x+j/2,0,.5*h.z+j/2),new THREE.Vector3(h.x*-.5-j/2,0,.5*h.z+j/2),new THREE.Vector3(h.x*-.5-j/2,0,0+j/2),new THREE.Vector3(-3.5*h.x-j/2,0,0+j/2),new THREE.Vector3(-3.5*h.x-j/2,0,-h.z-j/2),new THREE.Vector3(h.x*-.5-j/2,0,-h.z-j/2)];n.vertices.push(q[1],q[2]),n.vertices.push(q[2],q[3]),n.vertices.push(q[3],q[4]),n.vertices.push(q[4],q[5]),n.vertices.push(q[5],q[6]),n.vertices.push(q[6],q[7]),n.vertices.push(q[7],q[8]),n.vertices.push(q[8],q[1]),o.vertices.push(q[1],q[2]),o.vertices.push(q[2],q[7]),o.vertices.push(q[7],q[8]),o.vertices.push(q[8],q[1]),p.vertices.push(q[0],q[3]),p.vertices.push(q[3],q[6]),p.vertices.push(q[6],q[9]),p.vertices.push(q[9],q[0]),i.merge(n.clone()),i.merge(n.clone(),(new THREE.Matrix4).makeTranslation(0,h.y-.5,0)),i.merge(n.clone(),(new THREE.Matrix4).makeTranslation(0,h.y,0)),i.merge(o.clone(),(new THREE.Matrix4).makeTranslation(0,2*h.y,0)),i.merge(o.clone(),(new THREE.Matrix4).makeTranslation(0,2*h.y+.5,0)),i.merge(o.clone(),(new THREE.Matrix4).makeTranslation(0,3*h.y,0)),i.merge(o.clone(),(new THREE.Matrix4).makeTranslation(0,3*h.y+.5,0)),i.merge(o.clone(),(new THREE.Matrix4).makeTranslation(0,4*h.y,0)),i.merge(o.clone(),(new THREE.Matrix4).makeTranslation(0,4*h.y+.5,0)),i.merge(p.clone(),(new THREE.Matrix4).makeTranslation(0,5*h.y+1,0)),i.merge(p.clone(),(new THREE.Matrix4).makeTranslation(0,5*h.y+2,0));var r=new THREE.TorusGeometry(2,.5,8,6);r.applyMatrix((new THREE.Matrix4).makeRotationZ(THREE.Math.degToRad(30))),r.applyMatrix((new THREE.Matrix4).makeTranslation(0,12,1)),i.merge(r),this.add(new THREE.Line(i,d,THREE.LinePieces)),a=new THREE.JSONLoader,a.load("./3d/logo1.js",function(a){var b=new THREE.Mesh(a,d);b.position.set(-17,g*h.y+.5,-.5),b.rotation.x=THREE.Math.degToRad(90),b.scale.set(3,3,3),e.add(b)}),a=new THREE.JSONLoader,a.load("./3d/logo2.js",function(a){var b=new THREE.Mesh(a,d);b.position.set(19,g*h.y+.5,-.5),b.rotation.x=THREE.Math.degToRad(90),b.scale.set(3,3,3),e.add(b)})},NF14.view3d.BuildingMesh.prototype=Object.create(THREE.Object3D.prototype);var d=THREE.ImageUtils.loadTexture("./3d/star.png"),e=THREE.ImageUtils.loadTexture("./3d/circle.png"),f=["attribute float shift;","uniform float time;","uniform float size;","uniform float lifetime;","uniform float perspective;","varying float t;","","float cubicOut(float t) {","  float f = t - 1.0;","  return f * f * f + 1.0;","}","","void main () {","","  t = time / lifetime - shift / 15.;","  vec3 scaledPosition = position * cubicOut( t );","  vec4 pos = projectionMatrix * modelViewMatrix * vec4( scaledPosition, 1. );","","  gl_Position = pos;","  gl_PointSize = ( perspective * size ) / gl_Position.w;","","}"].join(""),g=["uniform vec3 headColor;","uniform sampler2D texture;","","varying float t;","","void main() {","","  vec3 color;","  float alpha = min( 1. - smoothstep( 0., 1., t ), 1. );","","  color = headColor;","  alpha = min( alpha * 2., 1. );","","  gl_FragColor = texture2D( texture, gl_PointCoord ) * vec4( color, alpha );","","}"].join(""),h=function(a){var b=a-1;return b*b*b+1};NF14.view3d.Fire=function(a,b,c,h,i){THREE.EventDispatcher.prototype.apply(this),this.viewport=h,this.isNPC=i;var j,k,l,m=i?e:d,b=b;j={layer:{type:"f",value:[]},shift:{type:"f",value:[]}},k={time:{type:"f",value:0},size:{type:"f",value:i?1.25:2},headColor:{type:"c",value:new THREE.Color(b)},texture:{type:"t",value:m},lifetime:{type:"f",value:2},perspective:{type:"f",value:Math.abs(h.height/(2*Math.tan(THREE.Math.degToRad(h.camera.fov))))}},l=new THREE.ShaderMaterial({vertexShader:f,fragmentShader:g,uniforms:k,attributes:j,transparent:!0,depthTest:!1});var n,o,p,q,r,s,t,u=8,v=new THREE.Geometry,w=256,x=1;for(s=0;w>s;s++)for(n=2*Math.random()-1,o=6.2832*Math.random(),p=Math.sqrt(1-n*n),q=new THREE.Vector3(p*Math.cos(o),p*Math.sin(o),n).multiplyScalar(u),r=.4*Math.random(),t=0;x>t;t++)v.vertices.push(q.clone()),l.attributes.layer.value.push(t),l.attributes.shift.value.push(r);if(this.clock=new THREE.Clock,this.object=new THREE.PointCloud(v,l),this.object.position.copy(a),this.viewport.scene.add(this.object),this._onupdate=this.update.bind(this),this.viewport.addEventListener("update",this._onupdate),!this.isNPC){var y,z=512,A=80,B=6,C=-~(c.length/B),D=A/2+(C-1)*-.5*A,E=document.createElement("canvas");E.width=z,E.height=z;var F=E.getContext("2d");F.font="bold "+A+"px Arial",F.textAlign="center",F.lineWidth=16,F.shadowColor="#f4fb7f",F.shadowBlur=30;for(var s=0,G=C;G>s;s++)y=c.slice(C*s,C*s+B),F.shadowBlur=10,F.strokeStyle="#179976",F.strokeText(y,z/2,z/2+A*s+D),F.shadowBlur=0,F.fillStyle="#fff",F.fillText(y,z/2,z/2+A*s+D),console.log(z/2+A*s+D);var H=new THREE.Texture(E);H.needsUpdate=!0;var I=new THREE.SpriteMaterial({color:16777215,map:H,opacity:.5,transparent:!0,useScreenCoordinates:!1});this.billboard=new THREE.Sprite(I),this.billboard.position.copy(a),this.viewport.scene.add(this.billboard)}},NF14.view3d.Fire.prototype.update=function(){var a=this.object.material.uniforms.lifetime.value,b=this.clock.getElapsedTime(),c=b/a;return c>=1?void this.dispose():(this.object.material.uniforms.time.value=b,this.object.position.y+=.025*Math.cos(c*Math.PI),void(this.isNPC||(this.billboard.scale.set(10*Math.min(h(2*c),1),10*Math.min(h(2*c),1),1),this.billboard.position.copy(this.object.position),this.billboard.material.opacity=Math.sin(c*Math.PI))))},NF14.view3d.Fire.prototype.dispose=function(){this.viewport.scene.remove(this.object),this.object.geometry.dispose(),this.object.material.dispose(),this.dispatchEvent({type:"disposed"}),this.viewport.removeEventListener("update",this._onupdate),this.isNPC||(this.viewport.scene.remove(this.billboard),this.billboard.geometry.dispose(),this.billboard.material.dispose(),this.billboard.material.map.dispose())},NF14.view3d.InputUI=function(a,b){var c=this;this.$window=$(window),this.$viewport=$(a),this.$cursor=this.$viewport.find(".view3d__cursor"),this.$input=this.$viewport.find("input"),this.$ignore=this.$viewport.find(".view3d__ignore"),this.cursorPosition=new THREE.Vector2,this.isCoolTime=!1,this.isFocusing=!1,this.viewportOffset=this.$viewport.offset(),this.cameraCtrl=new NF14.view3d.CameraControl(b),this.viewport=b,c.$cursor.addClass("view3d__cursor--focused"),c.$viewport.on("mousemove",function(a){c.cursorPosition.set(a.clientX-c.viewportOffset.left,a.clientY-c.viewportOffset.top),c.$cursor.css({left:c.cursorPosition.x,top:c.cursorPosition.y})}),c.$input.on("blur",function(){c.isFocusing=!1,c.$input.val("")}),c.$window.on("keydown",function(a){if(13===a.keyCode){if(c.isCoolTime)return;if(c.isFocusing){var d=c.$input.val(),e=c.cursorPosition.x/c.$viewport.width()*2-1,f=2*-(c.cursorPosition.y/c.$viewport.height())+1,g=new THREE.Vector3(e,f,1),h=new THREE.Projector;h.unprojectVector(g,b.camera);var i=(new THREE.Vector3).subVectors(g,c.viewport.camera.position);i.normalize();var j=-c.viewport.camera.position.z/i.z,k=c.viewport.camera.position.clone().add(i.multiplyScalar(j)),l=[16055167,5107967,5138932,16497115][4*Math.random()|0],m=new NF14.view3d.Fire(k,l,d,c.viewport);c.$cursor.removeClass("view3d__cursor--focused"),m.addEventListener("disposed",function(){c.isCoolTime=!1,c.$cursor.addClass("view3d__cursor--focused")}),c.isCoolTime=!0,c.viewport.dispatchEvent({type:"userinput:fire",position:k,color:l,text:d}),c.$input.blur()}else c.isFocusing=!0,c.$input.focus()}}),this.$viewport.on("mouseout",function(a){a.stopPropagation(),c.$viewport.addClass("view3d--onbutton")}),this.$viewport.on("mouseover",function(a){a.stopPropagation(),c.$viewport.removeClass("view3d--onbutton")}),this.$ignore.on("mouseover",function(a){a.stopPropagation(),c.$viewport.addClass("view3d--onbutton")}),this.$ignore.on("mouseout",function(a){a.stopPropagation(),c.$viewport.removeClass("view3d--onbutton")}),this.cameraCtrl.addEventListener("mousedown",function(){c.$input.blur(),c.$viewport.addClass("view3d--dragging")}),this.cameraCtrl.addEventListener("mouseup",function(){c.$viewport.removeClass("view3d--dragging")})}}(),function(){if(Modernizr.webgl){var a=$(".l-header").height(),b=window.innerWidth,c=window.innerHeight-a,d=new NF14.view3d.Viewport(document.getElementById("fireworks"));d.setSize(b,c),d.run();var e=new NF14.view3d.BuildingMesh;d.scene.add(e);var f=(new NF14.view3d.InputUI(document.getElementById("fireworks"),d),new PeriodicEventEmitter(750));f.addEventListener("period",function(){{var a=new THREE.Vector3(40*Math.random()-20,40*Math.random(),40*Math.random()-20),b=7796371;new NF14.view3d.Fire(a,b,"",d,!0)}}),$(window).on("resize",function(){var b=window.innerWidth,c=window.innerHeight-a;d.setSize(b,c)});var g=io("http://nodefest2014.c.node-ninja.com/");d.addEventListener("userinput:fire",function(a){var b={x:a.position.x,y:a.position.y,z:a.position.z,color:a.color,text:a.text};console.log(b),g.emit("server_fire",b)}),g.on("client_fire",function(a){var b=new THREE.Vector3(a.x,a.y,a.z);new NF14.view3d.Fire(b,a.color,a.text,d)})}}();